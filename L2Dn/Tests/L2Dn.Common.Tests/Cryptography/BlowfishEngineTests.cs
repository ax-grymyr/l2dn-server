using System.Runtime.InteropServices;
using FluentAssertions;
using L2Dn.Cryptography;

namespace L2Dn.Common.Tests.Cryptography;

public class BlowfishEngineTests
{
    [Fact]
    public void Test1()
    {
        ReadOnlySpan<byte> key = "_;5.]94-31==-%xT!^[$\0"u8;

        const string text =
            "Lorem ipsum dolor sit amet, consectetur adipiscing elit. " +
            "Phasellus diam ligula, rhoncus mollis ex laoreet, ornare viverra nulla. " +
            "Phasellus congue lectus vitae nulla pretium ullamcorper. Etiam hendrerit " +
            "libero quis ipsum lacinia, a feugiat urna consequat. Ut finibus porta sem " +
            "eu iaculis. Pellentesque sed odio eget lacus dapibus rhoncus quis quis magna. " +
            "In hac habitasse platea dictumst. Phasellus tempor et purus ac suscipit. " +
            "Proin a mi elit. Sed tincidunt, nisi quis tempor vehicula, lorem quam " +
            "vulputate ligula, non porttitor arcu odio nec leo. Sed tempus dignissim " +
            "risus, a accumsan arcu. Aliquam erat volutpat. Nam vel arcu convallis, " +
            "feugiat augue vitae, dignissim libero. Donec luctus finibus dolor, " +
            "id viverra mi dapibus non";

        ReadOnlySpan<byte> expectedEncryptedData =
        [
            88, 44, 89, 193, 13, 209, 59, 123, 129, 172, 8, 9, 157, 14, 191, 162, 114, 34, 22, 86, 191, 81, 164, 231,
            117, 101, 116, 244, 129, 189, 57, 140, 30, 193, 138, 141, 215, 13, 117, 241, 183, 165, 43, 148, 37, 204,
            184, 247, 8, 186, 146, 179, 53, 113, 89, 206, 173, 235, 152, 119, 126, 116, 120, 3, 103, 238, 233, 89, 41,
            226, 10, 45, 201, 17, 171, 233, 236, 187, 207, 94, 108, 14, 188, 184, 82, 92, 184, 7, 188, 64, 41, 18, 36,
            84, 10, 42, 207, 28, 83, 207, 164, 122, 75, 158, 38, 247, 59, 146, 17, 159, 26, 87, 245, 160, 166, 94, 43,
            103, 165, 220, 163, 148, 129, 165, 40, 125, 233, 6, 137, 66, 155, 66, 91, 10, 220, 21, 64, 187, 87, 31, 73,
            250, 172, 253, 102, 151, 242, 141, 160, 219, 144, 252, 55, 83, 222, 8, 204, 41, 58, 235, 132, 229, 5, 72,
            136, 7, 254, 142, 181, 107, 215, 154, 114, 99, 143, 88, 151, 125, 99, 8, 81, 133, 150, 183, 77, 53, 123,
            134, 255, 16, 156, 171, 117, 164, 187, 147, 106, 205, 9, 22, 152, 201, 242, 93, 21, 232, 147, 253, 85, 168,
            160, 217, 252, 206, 152, 43, 18, 63, 154, 83, 199, 174, 213, 212, 71, 135, 208, 155, 4, 162, 7, 80, 54, 88,
            63, 115, 104, 90, 140, 145, 59, 80, 227, 12, 114, 41, 70, 248, 84, 216, 185, 122, 168, 209, 84, 153, 245,
            160, 166, 94, 43, 103, 165, 220, 163, 148, 129, 165, 40, 125, 233, 6, 105, 84, 212, 177, 124, 44, 88, 187,
            75, 141, 141, 89, 253, 56, 91, 122, 237, 161, 126, 13, 42, 207, 120, 96, 100, 13, 118, 8, 49, 250, 2, 212,
            187, 171, 248, 175, 46, 15, 169, 118, 188, 80, 252, 37, 228, 206, 125, 2, 27, 127, 81, 173, 4, 133, 78, 157,
            244, 102, 29, 144, 141, 49, 118, 152, 134, 37, 42, 24, 125, 241, 207, 52, 84, 86, 62, 245, 159, 4, 226, 143,
            38, 57, 134, 190, 141, 146, 24, 111, 10, 219, 105, 36, 41, 147, 177, 135, 214, 170, 191, 15, 147, 114, 250,
            153, 64, 187, 87, 31, 73, 250, 172, 253, 49, 167, 240, 128, 195, 215, 110, 11, 164, 127, 199, 48, 155, 203,
            54, 185, 196, 149, 120, 176, 208, 137, 188, 200, 184, 167, 13, 156, 121, 224, 241, 239, 187, 120, 48, 190,
            143, 35, 92, 151, 179, 144, 112, 74, 164, 117, 9, 25, 114, 34, 22, 86, 191, 81, 164, 231, 39, 3, 196, 121,
            238, 143, 42, 28, 12, 157, 156, 160, 62, 73, 140, 133, 3, 21, 143, 244, 148, 144, 159, 194, 235, 13, 100,
            122, 192, 162, 118, 214, 234, 51, 72, 11, 67, 147, 12, 208, 221, 245, 40, 241, 50, 66, 216, 112, 173, 235,
            152, 119, 126, 116, 120, 3, 68, 65, 106, 244, 239, 96, 205, 253, 158, 86, 21, 205, 138, 242, 9, 241, 132,
            58, 126, 111, 93, 12, 167, 35, 181, 24, 158, 1, 0, 92, 140, 174, 137, 50, 172, 65, 12, 124, 4, 247, 134,
            183, 83, 19, 108, 235, 78, 223, 139, 108, 93, 12, 4, 184, 207, 16, 103, 70, 69, 33, 189, 27, 224, 119, 8,
            48, 106, 251, 191, 132, 134, 13, 48, 125, 44, 89, 54, 108, 131, 202, 245, 98, 76, 108, 213, 239, 41, 1, 131,
            100, 45, 216, 58, 69, 46, 122, 187, 145, 176, 67, 68, 152, 21, 49, 63, 174, 170, 129, 107, 19, 0, 124, 78,
            102, 59, 5, 107, 15, 249, 192, 200, 148, 58, 221, 106, 30, 173, 100, 67, 255, 22, 42, 115, 250, 209, 158,
            154, 145, 184, 132, 59, 79, 147, 235, 21, 52, 14, 119, 1, 53, 159, 20, 162, 119, 233, 94, 141, 204, 69, 99,
            194, 242, 8, 56, 68, 7, 214, 14, 174, 116, 155, 77, 162, 69, 148, 121, 187, 120, 48, 190, 143, 35, 92, 151,
            33, 73, 119, 165, 91, 97, 122, 162, 156, 38, 248, 162, 6, 213, 27, 205, 60, 227, 137, 243, 10, 78, 190, 110,
            105, 113, 31, 71, 91, 182, 28, 198, 169, 30, 101, 68, 171, 164, 97, 219, 175, 134, 246, 7, 109, 86, 110,
            179, 243, 110, 247, 82, 87, 201, 195, 116, 192, 32, 2, 28, 170, 162, 234, 172, 21, 123, 244, 175, 246, 255,
            132, 182, 6, 146, 129, 129, 57, 71, 184, 202, 132, 23, 7, 184, 27, 83, 116, 60, 153, 72, 118, 2, 173, 160,
            15, 13, 140, 3, 205, 4, 254, 32, 141, 92, 164, 34, 70, 213, 11, 26, 74, 39, 142, 206, 191, 191, 133, 235,
            253, 136, 106, 62, 241, 176, 29, 65, 182, 197, 233, 211, 97, 148, 192, 6, 239, 205, 40, 102, 113, 61, 52,
            36, 122, 6, 86, 88, 9, 98, 60, 141, 177, 168, 97, 79, 158, 246, 113, 207, 40, 197, 213, 124, 183, 68, 11,
            193, 119, 181, 159, 105, 169, 17, 10, 193, 182, 56, 158, 113, 31, 237, 139, 87, 235, 172, 130, 171, 164, 88,
            135, 143, 249, 224, 52, 70, 130, 153, 243, 143, 165, 73, 76, 189, 112, 185, 206, 191, 240, 228, 164, 48,
            243, 149, 76, 123, 17, 241, 167, 137, 35, 10, 34, 60, 105, 113, 211, 197, 24, 78, 222, 3, 114, 25, 16, 53,
            115, 255, 190, 101, 70, 184, 45, 8, 101, 149, 238, 39, 230, 187, 76, 24, 81, 179, 233, 47, 7, 174, 218, 5,
            184, 59, 205, 188, 164, 11, 82, 3, 127, 115, 126, 201, 210, 91, 180, 157, 25, 1, 89, 20, 207, 220, 93, 193,
            149, 173, 5, 76, 125, 4, 173, 184, 147, 44, 172, 79, 132, 24, 222, 212, 238, 220, 36, 229, 164, 135, 51,
            118, 105, 207, 189, 79, 161, 206, 195, 131, 3, 12, 73, 29, 150, 118, 133, 167, 227, 140, 152, 43, 163, 27,
            158, 31, 133, 222, 203, 221, 43, 225, 167, 219, 72, 201, 93, 168, 114, 15, 58, 182, 48, 135, 36, 12, 109,
            94, 188, 39, 100, 129, 66, 22, 129, 200, 90, 196, 112, 142, 42, 58, 16, 202, 3, 80, 197, 20, 92, 244, 88,
            152, 14, 26, 164, 170, 22, 15, 244, 50, 228, 146, 227, 95, 43, 80, 121, 166, 124, 90, 237, 164, 229, 26,
            228, 39, 162, 31, 178, 136, 110, 180, 11, 11, 220, 55, 61, 163, 162, 244, 45, 93, 164, 48, 243, 149, 76,
            123, 17, 241, 187, 75, 224, 116, 91, 255, 87, 206, 137, 66, 155, 66, 91, 10, 220, 21, 113, 31, 72, 154, 173,
            23, 219, 33, 75, 114, 211, 129, 202, 13, 246, 131, 112, 250, 156, 193, 223, 106, 144, 250, 26, 206, 82, 31,
            177, 10, 71, 223, 180, 58, 169, 27, 204, 149, 98, 138, 238, 100, 133, 141, 217, 108, 103, 93, 62, 85, 254,
            196, 113, 163, 7, 157, 56, 82, 96, 52, 113, 130, 58, 179, 84, 41, 216, 24, 87, 120, 253, 46, 51, 118, 105,
            207, 189, 79, 161, 206, 38, 80, 162, 100, 218, 183, 29, 80, 2, 12, 237, 218, 223, 49, 11, 44, 51, 244, 71,
            44, 182, 14, 83, 133, 239, 117, 220, 40, 204, 26, 35, 69, 218, 29, 105, 156, 48, 163, 233, 58, 236, 235, 17,
            14, 195, 86, 94, 10, 11, 80, 8, 30, 25, 187, 65, 234, 203, 71, 186, 96, 161, 241, 163, 205, 226, 223, 130,
            109, 159, 11, 97, 133, 175, 221, 171, 26, 174, 189, 172, 125, 36, 98, 122, 238, 223, 208, 206, 65, 88, 50,
            37, 119, 78, 16, 27, 125, 120, 40, 231, 232, 129, 52, 149, 237, 71, 135, 208, 155, 4, 162, 7, 80, 223, 207,
            124, 144, 76, 214, 197, 96, 155, 192, 236, 188, 254, 55, 60, 213, 15, 55, 36, 118, 59, 76, 210, 213, 39,
            129, 33, 103, 177, 196, 244, 5, 112, 21, 22, 162, 93, 69, 126, 142, 113, 121, 54, 69, 29, 214, 188, 159,
            147, 158, 201, 249, 14, 109, 83, 119, 216, 190, 222, 47, 226, 72, 161, 240, 158, 185, 59, 114, 83, 223, 194,
            191, 161, 219, 47, 112, 169, 213, 255, 161, 38, 108, 183, 173, 210, 207, 180, 130, 117, 101, 116, 244, 129,
            189, 57, 140, 91, 169, 166, 116, 54, 226, 146, 245, 17, 26, 146, 181, 11, 228, 111, 37, 54, 88, 63, 115,
            104, 90, 140, 145, 212, 2, 133, 25, 194, 2, 190, 194, 21, 52, 14, 119, 1, 53, 159, 20, 162, 119, 233, 94,
            141, 204, 69, 99, 208, 169, 151, 111, 119, 234, 225, 168
        ];

        BlowfishEngine engine = new BlowfishEngine(key);
        ReadOnlySpan<byte> textData = MemoryMarshal.Cast<char, byte>(text);
        Span<byte> encryptedData = stackalloc byte[textData.Length];
        engine.Encode(encryptedData, textData);
        Span<byte> decryptedData = stackalloc byte[textData.Length];
        engine.Decode(decryptedData, encryptedData);

        encryptedData.SequenceEqual(expectedEncryptedData).Should().BeTrue();
        textData.SequenceEqual(decryptedData).Should().BeTrue();
    }
}